{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "autosize": { "type": "fit", "contains": "padding", "resize": true },
  "padding": 5,
  "width": 800,
  "height": 350,

  "data": [
    {
      "name": "raw",
      "url": "https://raw.githubusercontent.com/dorj0330/engui-ot-files/refs/heads/main/data.csv",
      "format": { "type": "csv" },
      "transform": [
        {
          "type": "formula",
          "as": "DateParsed",
          "expr": "isString(datum['Date']) ? (isValid(timeParse(datum['Date'], '%Y-%m-%d %H:%M:%S')) ? timeParse(datum['Date'], '%Y-%m-%d %H:%M:%S') : toDate(replace(datum['Date'], ' ', 'T'))) : toDate(datum['Date'])"
        },
        { "type": "formula", "as": "TotalHead", "expr": "toNumber(datum['Average of Total Head'])" },
        { "type": "formula", "as": "Rainfall", "expr": "toNumber(datum['Average of Daily rainfall'])" },
        { "type": "filter", "expr": "isValid(datum.DateParsed) && isValid(datum.TotalHead)" }
      ]
    },

    {
      "name": "stats",
      "source": "raw",
      "transform": [
        {
          "type": "aggregate",
          "fields": ["TotalHead", "TotalHead", "DateParsed"],
          "ops": ["min", "max", "min"],
          "as": ["yMin", "yMax", "xMin"]
        },
        { "type": "formula", "as": "padFrac", "expr": "0.3" },
        { "type": "formula", "as": "yPad", "expr": "(datum.yMax - datum.yMin) * datum.padFrac" },
        { "type": "formula", "as": "domainMin", "expr": "datum.yMin - datum.yPad" }
      ]
    },

    {
      "name": "rainByDay",
      "source": "raw",
      "transform": [
        { "type": "formula", "as": "Day", "expr": "timeFormat(datum.DateParsed, '%Y-%m-%d')" },
        {
          "type": "aggregate",
          "groupby": ["Day"],
          "fields": ["DateParsed", "Rainfall"],
          "ops": ["min", "mean"],
          "as": ["DayDate", "RainDay"]
        },
        { "type": "formula", "as": "RainClamped", "expr": "min(max(datum.RainDay, 0), 30)" }
      ]
    }
  ],

  "signals": [
    { "name": "rainMax", "value": 30 }
  ],

  "scales": [
    {
      "name": "x",
      "type": "time",
      "domain": { "data": "raw", "field": "DateParsed" },
      "range": "width"
    },

    {
      "name": "yHead",
      "type": "linear",
      "domain": [
        { "signal": "data('stats')[0].domainMin" },
        { "signal": "data('stats')[0].yMax" }
      ],
      "nice": true,
      "zero": false,
      "range": "height"
    },

    {
      "name": "yRain",
      "type": "linear",
      "domain": [0, { "signal": "rainMax" }],
      "range": [
        { "signal": "height" },
        { "signal": "scale('yHead', data('stats')[0].yMin)" }
      ]
    },

    {
      "name": "color",
      "type": "ordinal",
      "domain": { "data": "raw", "field": "Drillhole_USC" },
      "range": { "scheme": "category10" }
    }
  ],

  "axes": [
    {
      "orient": "bottom",
      "scale": "x",
      "title": "Date",
      "labelAngle": -45,
      "labelAlign": "right"
    },
    {
      "orient": "left",
      "scale": "yHead",
      "title": "Total Head"
    },
    {
      "orient": "right",
      "scale": "yRain",
      "title": "Rainfall (0â€“30)",
      "grid": false,
      "tickCount": 7
    }
  ],

  "legends": [
    { "fill": "color", "title": "Drillhole USC" }
  ],

  "marks": [
    {
      "type": "rect",
      "from": { "data": "rainByDay" },
      "encode": {
        "update": {
          "x": { "scale": "x", "field": "DayDate" },
          "width": { "value": 2 },
          "y": { "scale": "yRain", "field": "RainClamped" },
          "y2": { "scale": "yRain", "value": 0 },
          "opacity": { "value": 1 }
        }
      }
    },

    {
      "type": "group",
      "from": {
        "facet": { "data": "raw", "name": "series", "groupby": "Drillhole_USC" }
      },
      "marks": [
        {
          "type": "line",
          "from": { "data": "series" },
          "encode": {
            "update": {
              "x": { "scale": "x", "field": "DateParsed" },
              "y": { "scale": "yHead", "field": "TotalHead" },
              "stroke": { "scale": "color", "field": "Drillhole_USC" },
              "strokeWidth": { "value": 2 }
            }
          }
        }
      ]
    }
  ]
}
